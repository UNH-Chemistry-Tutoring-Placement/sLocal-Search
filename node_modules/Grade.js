module.exports = {
    grade: Grade,
    gradeWith: GradeWith,
    gradeWithout: GradeWithout,
    gradeTotal: GradeTotal,
    gradeSwap: GradeSwap
};

var data = require('FileData').get();

function Grade(timeslot, studentsInTimeslot){
    
    // penalties
    var belowMin = data.objective.penalties.belowMin
    var aboveMax = data.objective.penalties.aboveMax
    var possChoice = data.objective.penalties.possibleChoice
    var genderSolo = data.objective.penalties.genderSolo;
    var professorPenalty = data.objective.penalties.diffProfessor;
    var impossChoice = 10
    
    //state variables
    var grade = 0
    var male = 0;
    var female = 0;
    var sharedProfessor;
    var justTime = timeslot.split(/,/)[0];
    
    // grade group sizes
    if (studentsInTimeslot.length < data.objective.groupSize.min) 
        grade = grade + (belowMin * (data.objective.groupSize.min - studentsInTimeslot.length));
    
    if (studentsInTimeslot.length > data.objective.groupSize.max) 
        grade = grade + (aboveMax *  (studentsInTimeslot.length - data.objective.groupSize.max));
    
    // go through each student in this time slot
    for (i = 0; i < studentsInTimeslot.length; i++) {
        var stud = data.student.students[studentsInTimeslot[i]];
        
        //check gender solo 
        if (stud.sex.charAt(0) === "M" || stud.sex.charAt(0) === "m")
            male++;
        
        if (stud.sex.charAt(0) === "F" || stud.sex.charAt(0) === "f")
            female++;
        
        // check to make sure every student has the same professor
        if (i === 0) sharedProfessor = stud.professor;
        
        else if (sharedProfessor && stud.professor !== sharedProfessor)
            sharedProfessor = false;
        
        // check to see if a student is in their good or possible times
        if (stud.goodTimes.indexOf( justTime ) > -1 )
            continue;
        
        else if (stud.possibleTimes.indexOf( justTime ) > -1){
            grade = grade + possChoice;
            continue;
        } 
        else {
        grade += impossChoice;
//        console.log("we had an impossible choice", "timeslot", timeslot, "student", stud);
        }
    }
    
    
    //check gender balance
    if (male === 1 && female > 1 || female === 1 && male > 1)
        grade += genderSolo;
    
    //check different professor 
    if (!sharedProfessor)
        grade += professorPenalty;
    
    return grade;
}

function GradeWithout(timeslot, studentsInTimeslot, removeStudent) {
    
    var studentIndex = studentsInTimeslot.indexOf(removeStudent);
    
    //remove the student
    studentsInTimeslot.splice(studentIndex, 1);
    
    //grade it
    var grade = Grade(timeslot, studentsInTimeslot);
    
    //add back the student
    studentsInTimeslot.splice(studentIndex, 0, removeStudent);
    
    return grade;
}

function GradeWith(timeslot, studentsInTimeslot, extraStudent) {
    
    //add the student to the end
    studentsInTimeslot.push(extraStudent);
    
    //grade
    var grade = Grade(timeslot, studentsInTimeslot);
    
    //remove student
    studentsInTimeslot.pop();
    
    return grade;
    
}

function GradeSwap(timeslot, studentsInTimeslot, studentToAdd, studentToRemove){
    
    //remove student
    var studentIndex = studentsInTimeslot.indexOf(studentToRemove);
    
    //remove the student
    studentsInTimeslot.splice(studentIndex, 1);
    
    //add the extra student
    studentsInTimeslot.push(studentToAdd);
    
    //grade
    var grade = Grade(timeslot, studentsInTimeslot);
    
    //remove extra student
    studentsInTimeslot.pop();
    
    //add back student in right place
    studentsInTimeslot.splice(studentIndex, 0, studentToRemove);
    
    return grade;
    
}

function GradeTotal(times){
    var total = 0;
    
    for (var time in times){
        total += Grade(time, times[time]);
    }
    
    return total;
}