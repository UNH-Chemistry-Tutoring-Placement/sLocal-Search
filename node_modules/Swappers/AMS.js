module.exports = AMS;

var swap = require('Swappers/CoreFunctions').both,
    randAssign = require('randomAssignment'),
    data = require('FileData').get(),
    grader = require('Grade'),
    yargs = require('Yargs');


function AMS(){
    
    // first thing we're going to do is run our regular sort twenty times
    var results = [];
    
    for (var i = 0; i < 100; i++){
        
        results.push( swap( randAssign()) );
        
    }
    
    // set up our time variables
    var timeStart = new Date().getTime(),
        timeUp = yargs.time;
    
    while((new Date().getTime() - timeStart) < timeUp){
        
        // find the top 20 best results
        results = top(results);
        
        // get a random assignment to filter in some random change
        results.push(randAssign());
        
        // new solutions
        var newResults;
        
        for (var i = 0; i < 10; i++){
            
            // build a new assignment based on the top 20 results
            var assignment = {};
            newResults = [];

            // initialize the group times
            for (var groupTime in data.class.groups)
                assignment[groupTime] = [];

            for (var studEmail in data.student.students){
                var time = assignIndividual(studEmail, results);
                if (time)
                    assignment[ time ].push( studEmail );
            }

            // swap on this assignment and push the result on our results stack
            newResults.push( swap(assignment) );
            
        }
        
        results = results.concat(newResults);
            
        
    }
    
    results = top(results)
    
    return results[0];
}

//returns top 20 assignments by grade
function top(results){
    results.sort(function(a,b){return a.grade- b.grade});
    return results.slice(0,20);
}

//take student and pick one of their five assigned times -Think it might be missing some students-
function assignIndividual(student, bestSoFar){
    var randAssign = bestSoFar[ randNumber(0, bestSoFar.length) ].assignments;
    
    for(var time in randAssign){
        
        if (randAssign[time].indexOf(student) > -1)
            return time;
        
    }
    
    console.log("Student", student, "Doesn't have time!");
    
}

function randNumber(min,max){
    return Math.floor(Math.random() * (max-min) + min);
}