module.exports = Swap;

var grader = require('Grade'),
    rand = require('randomAssignment'),
    printOut = require('FileData').out,
    data = require('FileData').get();

function Swap(){
	
    
    var results = [],
        timeStart = new Date().getTime();
        timeUp = isNaN(Number(process.argv[2])) ? 1000 : Number(process.argv[2]) * 1000;
    
    while((new Date().getTime() - timeStart) < timeUp){
        var random = rand();

        //single swap until we go through and don't swap once
        do {
            var swapped = false;
            
            for (var time in random){

                //grade this time before any changes
                var beforePenalty1 = grader.grade(time, random[time]);

                for (var student of random[time]){

                    var afterPenalty1 = grader.gradeWithout(time, random[time], student);
                    
                    //difference
                    var diff1 = beforePenalty1 - afterPenalty1;
                    
                    //go through the good and possible time
                    var allTimes = data.student.students[student].goodTimes.concat(data.student.students[student].possibleTimes);
                    
                    for (var time2 of allTimes){
                        
                        if (time2 === time) continue; //ignore same time slot
                        
                        //if the student has a timeslot that isn't in the group slots
                        if (typeof random[time2] === 'undefined')
                            continue;
                        
                        var beforePenalty2 = grader.grade(time2, random[time2]);
                        var afterPenalty2 = grader.gradeWith(time2, random[time2], student);
                        var diff2 = beforePenalty2 - afterPenalty2;

                        var totalDiff = diff2 + diff1;

                        if (totalDiff > 0){
                            swapped = true;
                            random[time].splice(random[time].indexOf(student), 1);
                            random[time2].push(student);
                            break;
                        }
                    }
                }
            }
        } while(swapped);
    
        
        //double swap!!
        do {
            var swapped = false;
            
            for (var time in random){

                for (var student of random[time]){
                    
                    //see if this time is in the student's good times, if it is, skip this student
                    if (data.student.students[student].goodTimes.indexOf(time) > -1)
                        continue;
                    
                    //its in a possible time
                    //now we need to go through all the good time slots for this student, and see if there are students who can 
                    //switch with us.
                    for (var time2 in random){
                        
                        //need this variable so we can break out of this second for loop when we swap
                        var studentAlreadySwapped = false;
                        
                        //skip first time slot time
                        if (time === time2) continue;
                        
                        //is time2 a good time for the student?
                        if (data.student.students[student].goodTimes.indexOf(time2) > -1){
                            
                            //this student wants to move from his possible time slot to this good time slot. 
                            //are there any students in this time slot that can move?
                            
                            for (var student2 of random[time2]){
                                
                                //if this is a good time for student2, we'll only switch if time1 is also a good time
                                //if this is a possible time, just make sure time1 is either a possible time or good time
                                
                                //is time1 a good OR possible time for student 2?
                                if (data.student.students[student2].goodTimes.indexOf(time) > -1 
                                    || data.student.students[student2].possibleTimes.indexOf(time) > -1){
                                    
                                    //is time2 just a possible time for student2? 
                                    // OR
                                    // is time1 a good time for student 2, just move no matter what
                                    if (data.student.students[student2].possibleTimes.indexOf(time2) > -1
                                        || data.student.students[student2].goodTimes.indexOf(time) > -1){
                                        
                                        console.log("DOING SECOND SWAP");
                                        
                                        //SWAP
                                        //interestingly, we don't need to grade, YET. becuase we're not grading for sex balances and stuff.
                                        //currently we just check max/min size, and that never changes with swapping, and we know that we're
                                        //making a good swap so we're lowing the number of possible choices penalties.
                                        
                                        //remove student 1 from time 1
                                        var studIndex = random[time].indexOf(student);
                                        random[time].splice(studIndex, 1);
                                        
                                        //remove student 2 from time 2
                                        
                                        var stud2Index = random[time2].indexOf(student2);
                                        random[time2].splice(stud2Index, 1);
                                        
                                        //place student 2 in time 1
                                        random[time].splice(studIndex, 0 , student2);
                                        
                                        //place student 1 in time 2
                                        random[time2].splice(stud2Index, 0, student);
                                        
                                        swapped = true;
                                        studentAlreadySwapped = true;
                                        
                                        //break from first for loop
                                        break;
                                    } 
                                }
                            }
                        }
                        
                        //if we already swapped student1, stop looking for places to swap!
                        if (studentAlreadySwapped)
                            break;
                        
                    }
                }
            }
        } while(swapped);
        
        //idealy we'd do a double swap now but it looks like it's working pretty good
        var grade = grader.gradeTotal(random);
        if (typeof results[grade] === 'undefined')
            results[grade] = random;
        
    }
    
    for (var result in results){
        //best solution
        console.log("the score was", result, results[result]);
        printOut(results[result]);
        break;
    }

}


